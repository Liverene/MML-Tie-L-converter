<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>MML l코드 자동 변환기 (Parser Edition)</title>
<style>
    body { font-family: monospace; background:#f4f4f4; padding:20px; }
    textarea { width:100%; height:140px; margin:10px 0; padding:10px; }
    button { padding:10px 18px; font-size:15px; }
</style>
</head>

<body>
<h2>MML l코드 자동 변환기 (Full Parser)</h2>
<p>예: <code>l16d+l32&d+. → l16d+&d+32.</code></p>

<textarea id="input"></textarea>
<button onclick="convert()">변환하기</button>
<button onclick="clearAll()">지우기</button>
<textarea id="output"></textarea>

<script>
function tokenize(m) {
    const tokens = [];
    const regex = /t\d+|v\d+|l\d+|[<>]|&|[a-gr][#+-]?|r|\.|\d+|\s+/gi;

    let match;
    while ((match = regex.exec(m)) !== null) {
        const tk = match[0];
        if (!tk.trim()) continue; 
        tokens.push(tk);
    }
    return tokens;
}

function isPitch(t) {
    return /^[a-gr][#+-]?$/i.test(t);
}

function isLengthToken(t) {
    return /^l\d+$/i.test(t);
}

function isNumber(t) {
    return /^\d+$/.test(t);
}

function parseAndTransform(tokens) {
    const out = [];
    let i = 0;

    while (i < tokens.length) {
        const t = tokens[i];

        if (isLengthToken(t) && i + 1 < tokens.length && (isPitch(tokens[i+1]) || tokens[i+1] === 'r')) {
            const baseLength = t;
            const basePitch = tokens[i+1];
            i += 2;

            const cluster = {
                base: { length: baseLength, pitch: basePitch, dot: false },
                ties: []
            };

            if (tokens[i] === '.') {
                cluster.base.dot = true;
                i++;
            }

            while (i < tokens.length) {
                let saved_i = i;
                let lengthTwice = false;

                if (isLengthToken(tokens[i])) {
                    const len = tokens[i]; 
                    i++;

                    if (tokens[i] === '&') {
                        i++;
                        if (i < tokens.length && (isPitch(tokens[i]) || tokens[i] === 'r')) {
                            const tiePitch = tokens[i];
                            i++;

                            let numberPart = "";
                            let dotPart = false;

                            if (i < tokens.length && isNumber(tokens[i])) {
                                numberPart = tokens[i];
                                i++;
                            }
                            if (i < tokens.length && tokens[i] === '.') {
                                dotPart = true;
                                i++;
                            }

                            cluster.ties.push({
                                pitch: tiePitch,
                                number: numberPart,
                                dot: dotPart
                            });
                            continue;
                        }
                    }
                    i = saved_i;
                }

                if (tokens[i] === '&') {
                    i++;
                    if (i < tokens.length && (isPitch(tokens[i]) || tokens[i] === 'r')) {
                        const tiePitch = tokens[i];
                        i++;

                        let numberPart = "";
                        let dotPart = false;
                        if (i < tokens.length && isNumber(tokens[i])) {
                            numberPart = tokens[i];
                            i++;
                        }
                        if (i < tokens.length && tokens[i] === '.') {
                            dotPart = true;
                            i++;
                        }

                        cluster.ties.push({
                            pitch: tiePitch,
                            number: numberPart,
                            dot: dotPart
                        });
                        continue;
                    }
                    i = saved_i;
                }

                break;
            }

            out.push(cluster.base.length + cluster.base.pitch + (cluster.base.dot ? "." : ""));

            cluster.ties.forEach(tie => {
                out.push("&" + tie.pitch + (tie.number ? tie.number : "") + (tie.dot ? "." : ""));
            });

        } else {
            out.push(t);
            i++;
        }
    }

    return out.join('');
}

function convert() {
    const text = document.getElementById("input").value;
    const tokens = tokenize(text);
    const result = parseAndTransform(tokens);
    document.getElementById("output").value = result;
}

function clearAll() {
    document.getElementById("input").value = "";
    document.getElementById("output").value = "";
}
</script>

</body>
</html>